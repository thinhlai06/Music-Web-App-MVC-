@model MusicWeb.Models.ViewModels.HomeViewModel
@{
    var avatarUrl = Model.CurrentUser?.AvatarUrl ?? "https://ui-avatars.com/api/?name=User&background=9b4de0&color=fff";
}

<div id="profile-view" class="content-padding hidden">
    <div class="profile-header">
        <img src="@avatarUrl" class="profile-avatar-xl" alt="Avatar người dùng">
        <div class="profile-info">
            <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 15px;">
                <h2 style="margin: 0;">@(Model.CurrentUser?.DisplayName ?? "Khách")</h2>
                <div class="profile-actions">
                    <button class="pill-btn" id="profile-edit-btn"><i class="fa-solid fa-pen"></i> Chỉnh sửa</button>
                </div>
            </div>
            
            <div class="profile-stats" style="display: flex; gap: 40px; margin-bottom: 15px; font-size: 16px;">
                <div class="stat-item">
                    <span style="font-weight: bold; color: #fff;">@Model.CurrentUser?.PublicSongCount</span> bài hát
                </div>
                <div class="stat-item" onclick="openUserListModal('followers', '@Model.CurrentUser?.UserId')" style="cursor: pointer;">
                    <span style="font-weight: bold; color: #fff;">@Model.CurrentUser?.FollowersCount</span> người theo dõi
                </div>
                <div class="stat-item" onclick="openUserListModal('following', '@Model.CurrentUser?.UserId')" style="cursor: pointer;">
                    <span style="font-weight: bold; color: #fff;">@Model.CurrentUser?.FollowingCount</span> đang theo dõi
                </div>
            </div>

            <div style="display: flex; gap: 10px;">
                <span style="color: var(--text-secondary);">@(Model.CurrentUser?.Email ?? "Chưa đăng nhập")</span>
            </div>
        </div>
    </div>

    <div class="profile-nav-tabs">
        <div class="tab-item active">Tổng quan</div>
        <div class="tab-item">Bài hát</div>
        <div class="tab-item">Playlist</div>
        <div class="tab-item">Nghệ sĩ</div>        
    </div>

    <!-- Tab Content: Tổng quan -->
    <div class="profile-tab-content active" data-tab="0">
        <div class="section-title" style="margin-top: 0;">
            <span>Playlist Cá Nhân</span>
            <a href="#" id="profile-open-playlist">Tạo mới</a>
        </div>
        <div class="music-grid" id="profile-playlists-grid">
            <div class="card" id="create-playlist-card">
                <div class="card-img-wrapper" style="border: 1px dashed rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.05);">
                    <i class="fa-solid fa-plus" style="font-size: 40px; color: var(--purple-primary);"></i>
                </div>
                <div class="card-title" style="text-align: center;">Tạo Playlist mới</div>
            </div>
            @foreach (var playlist in Model.PersonalPlaylists)
            {
                var cover = string.IsNullOrWhiteSpace(playlist.CoverUrl) ? $"https://picsum.photos/seed/user-playlist-{playlist.Id}/300/300" : playlist.CoverUrl;
                <div class="card" data-playlist-id="@playlist.Id">
                    <div class="card-img-wrapper">
                        <img src="@cover" class="card-img" alt="@playlist.Title">
                        <div class="card-overlay">
                            <div class="play-btn-circle"><i class="fa-solid fa-play"></i></div>
                        </div>
                    </div>
                    <div class="card-title">@playlist.Title</div>
                    <div class="card-subtitle">@playlist.Subtitle</div>
                </div>
            }
        </div>

        <div class="section-title">
            <span>Bài hát yêu thích</span>
        </div>
        <div class="music-grid" id="favorite-songs-grid">
            @foreach (var song in Model.FavoriteSongs)
            {
                var cover = string.IsNullOrWhiteSpace(song.CoverUrl) ? $"https://picsum.photos/seed/fav-{song.Id}/300/300" : song.CoverUrl;
                <div class="card song-card" data-song-id="@song.Id" data-title="@song.Title" data-artist="@song.Artist"
                     data-cover="@cover" data-audio="@song.AudioUrl" data-duration="@song.Duration" data-favorite="true">
                    <div class="card-actions">
                        <button class="circle-btn favorite-toggle active"><i class="fa-solid fa-heart"></i></button>
                        <button class="circle-btn playlist-add"><i class="fa-solid fa-plus"></i></button>
                    </div>
                    <div class="card-img-wrapper">
                        <img src="@cover" class="card-img" alt="@song.Title">
                        <div class="card-overlay">
                            <div class="play-btn-circle"><i class="fa-solid fa-play"></i></div>
                        </div>
                    </div>
                    <div class="card-title">@song.Title</div>
                    <div class="card-subtitle">@song.Artist</div>
                </div>
            }
        </div>

        <div class="section-title">
            <span>Lịch sử nghe gần đây</span>
        </div>
        <div class="music-grid" id="recent-songs-grid">
            @foreach (var song in Model.RecentlyPlayed)
            {
                var cover = string.IsNullOrWhiteSpace(song.CoverUrl) ? $"https://picsum.photos/seed/history-{song.Id}/300/300" : song.CoverUrl;
                <div class="card song-card" data-song-id="@song.Id" data-title="@song.Title" data-artist="@song.Artist"
                     data-cover="@cover" data-audio="@song.AudioUrl" data-duration="@song.Duration" data-favorite="@song.IsFavorite">
                    <div class="card-actions">
                        <button class="circle-btn favorite-toggle @(song.IsFavorite ? "active" : string.Empty)"><i class="fa-solid fa-heart"></i></button>
                        <button class="circle-btn playlist-add"><i class="fa-solid fa-plus"></i></button>
                    </div>
                    <div class="card-img-wrapper">
                        <img src="@cover" class="card-img" alt="@song.Title">
                        <div class="card-overlay">
                            <div class="play-btn-circle"><i class="fa-solid fa-play"></i></div>
                        </div>
                    </div>
                    <div class="card-title">@song.Title</div>
                    <div class="card-subtitle">@song.Artist</div>
                </div>
            }
        </div>
    </div>

    <!-- Tab Content: Bài hát -->
    <div class="profile-tab-content" data-tab="1">
        <div class="section-title" style="margin-top: 0;">
            <span>Bài hát đã đăng tải</span>
        </div>
        <div class="music-grid" id="uploaded-songs-grid">
            @if (Model.UploadedSongs.Any())
            {
                @foreach (var song in Model.UploadedSongs)
                {
                    var cover = string.IsNullOrWhiteSpace(song.CoverUrl) ? $"https://picsum.photos/seed/uploaded-{song.Id}/300/300" : song.CoverUrl;
                    <div class="card song-card" data-song-id="@song.Id" data-title="@song.Title" data-artist="@song.Artist"
                         data-cover="@cover" data-audio="@song.AudioUrl" data-duration="@song.Duration" data-favorite="@song.IsFavorite">
                        <div class="card-actions">
                            @{
                                var eyeIcon = song.IsPublic ? "fa-eye" : "fa-eye-slash";
                                var eyeTitle = song.IsPublic ? "Đang công khai" : "Đang riêng tư";
                                var eyeClass = song.IsPublic ? "active" : "";
                            }
                            <button class="circle-btn visibility-toggle @eyeClass" title="@eyeTitle" onclick="toggleVisibility(event, @song.Id, this)">
                                <i class="fa-solid @eyeIcon"></i>
                            </button>
                            <button class="circle-btn delete-song-btn" title="Xóa bài hát" onclick="deleteSong(event, @song.Id, this)" style="color: #ff4d4d;">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                            <button class="circle-btn favorite-toggle @(song.IsFavorite ? "active" : string.Empty)"><i class="fa-solid fa-heart"></i></button>
                            <button class="circle-btn playlist-add"><i class="fa-solid fa-plus"></i></button>
                        </div>
                        <div class="card-img-wrapper">
                            <img src="@cover" class="card-img" alt="@song.Title">
                            @if (!song.IsPublic)
                            {
                                <div class="private-badge"><i class="fa-solid fa-lock"></i> Riêng tư</div>
                            }
                            <div class="card-overlay">
                                <div class="play-btn-circle"><i class="fa-solid fa-play"></i></div>
                            </div>
                        </div>
                        <div class="card-title">@song.Title</div>
                        <div class="card-subtitle">@song.Artist</div>
                    </div>
                }
            }
            else
            {
                <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--text-secondary);">
                    <i class="fa-solid fa-music" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                    <p>Bạn chưa đăng tải bài hát nào</p>
                </div>
            }
        </div>
    </div>

    <!-- Tab Content: Playlist -->
    <div class="profile-tab-content" data-tab="2">
        <div class="section-title" style="margin-top: 0;">
            <span>Playlist Cá Nhân</span>
            <a href="#" id="profile-open-playlist-tab">Tạo mới</a>
        </div>
        <div class="music-grid">
            <div class="card" id="create-playlist-card-tab">
                <div class="card-img-wrapper" style="border: 1px dashed rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.05);">
                    <i class="fa-solid fa-plus" style="font-size: 40px; color: var(--purple-primary);"></i>
                </div>
                <div class="card-title" style="text-align: center;">Tạo Playlist mới</div>
            </div>
            @foreach (var playlist in Model.PersonalPlaylists)
            {
                var cover = string.IsNullOrWhiteSpace(playlist.CoverUrl) ? $"https://picsum.photos/seed/user-playlist-{playlist.Id}/300/300" : playlist.CoverUrl;
                <div class="card" data-playlist-id="@playlist.Id">
                    <div class="card-img-wrapper">
                        <img src="@cover" class="card-img" alt="@playlist.Title">
                        <div class="card-overlay">
                            <div class="play-btn-circle"><i class="fa-solid fa-play"></i></div>
                        </div>
                    </div>
                    <div class="card-title">@playlist.Title</div>
                    <div class="card-subtitle">@playlist.Subtitle</div>
                </div>
            }
        </div>
    </div>

    <!-- Tab Content: Nghệ sĩ -->
    <div class="profile-tab-content" data-tab="3">
        <div class="section-title" style="margin-top: 0;">
            <span>Nghệ sĩ theo dõi</span>
        </div>
        <div style="padding: 40px; text-align: center; color: var(--text-secondary);">
            <i class="fa-solid fa-user-music" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
            <p>Tính năng đang phát triển</p>
        </div>
    </div>
</div>

<script>
    async function deleteSong(event, songId, btn) {
        event.stopPropagation();
        event.preventDefault();

        if (!confirm('Bạn có chắc chắn muốn xóa bài hát này? Hành động này không thể hoàn tác.')) {
            return;
        }

        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
        btn.disabled = true;

        try {
            const response = await fetch(`/upload/delete/${songId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (data.success) {
                // Remove card from UI
                const card = btn.closest('.song-card');
                if (card) {
                    card.style.transition = 'opacity 0.5s';
                    card.style.opacity = '0';
                    setTimeout(() => card.remove(), 500);
                }
                // Show toast (assuming showToast is global, if not we use alert)
                if (typeof showToast === 'function') {
                    showToast('Đã xóa bài hát thành công');
                }
            } else {
                 throw new Error(data.message || "Failed");
            }
        } catch (error) {
            console.error('Error deleting song:', error);
            btn.innerHTML = originalHtml;
            btn.disabled = false;
            alert(error.message || 'Có lỗi xảy ra khi xóa bài hát');
        }
    }
    
    async function toggleVisibility(event, songId, btn) {
        event.stopPropagation(); // Prevent card click
        event.preventDefault();

        // Optimistic UI update
        const icon = btn.querySelector('i');
        const isCurrentlyPublic = icon.classList.contains('fa-eye');
        
        // Toggle UI
        const card = btn.closest('.card');
        const imgWrapper = card.querySelector('.card-img-wrapper');
        let badge = imgWrapper.querySelector('.private-badge');

        if (isCurrentlyPublic) {
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
            btn.classList.remove('active');
            btn.title = "Đang riêng tư";
            
            // Add badge if not exists
            if (!badge) {
                badge = document.createElement('div');
                badge.className = 'private-badge';
                badge.innerHTML = '<i class="fa-solid fa-lock"></i> Riêng tư';
                imgWrapper.insertBefore(badge, imgWrapper.firstChild); // Insert at top
            }
        } else {
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
            btn.classList.add('active');
            btn.title = "Đang công khai";
            
            // Remove badge
            if (badge) badge.remove();
        }

        try {
            const response = await fetch(`/upload/toggle/${songId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                 throw new Error("Failed");
            }
        } catch (error) {
            console.error('Error toggling visibility:', error);
            // Revert UI on error
             if (isCurrentlyPublic) {
                icon.classList.add('fa-eye');
                icon.classList.remove('fa-eye-slash');
                btn.classList.add('active');
            } else {
                icon.classList.add('fa-eye-slash');
                icon.classList.remove('fa-eye');
                btn.classList.remove('active');
            }
            alert('Có lỗi xảy ra khi thay đổi trạng thái');
        }
    }
</script>
